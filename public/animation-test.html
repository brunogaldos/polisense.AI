<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nairobi Energy Infrastructure - Real Data</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      font-family: 'Space Mono', monospace;
      overflow-x: hidden;
    }

    #container {
      position: relative;
      width: 100%;
      height: 300vh;
    }

    #stage {
      position: sticky;
      top: 0;
      height: 100vh;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #title {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-align: center;
      z-index: 1000;
    }

    #subtitle {
      position: absolute;
      top: 75px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.6);
      font-size: 12px;
      letter-spacing: 0.05em;
      text-align: center;
      z-index: 1000;
    }

    #persp {
      perspective: 2000px;
      perspective-origin: 50% 50%;
    }

    #scene {
      position: relative;
      width: 900px;
      height: 600px;
      transform-style: preserve-3d;
      transform: rotateX(60deg) rotateZ(-45deg) scale(0.65);
      opacity: 0;
      transition: opacity 1.2s ease 0.2s;
    }

    #scene.show {
      opacity: 1;
    }

    .layer {
      position: absolute;
      width: 900px;
      height: 600px;
      top: 0;
      left: 0;
      transform-style: preserve-3d;
      will-change: transform;
      transform: translateZ(0px);
    }

    .lf {
      width: 100%;
      height: 100%;
      border: 2px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
      background: #1a1a1a;
      position: relative;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
    }

    .map-container {
      width: 100%;
      height: 100%;
      position: absolute;
      inset: 0;
    }

    .data-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    canvas.overlay-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    .llabel {
      position: absolute;
      left: calc(100% + 20px);
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 12px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .layer.open .llabel {
      opacity: 1;
    }

    .ll-line {
      width: 35px;
      height: 2px;
      background: rgba(255, 255, 255, 0.5);
      flex-shrink: 0;
    }

    .ll-n {
      font-size: 15px;
      font-weight: 700;
      font-style: italic;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.9);
      display: block;
      text-transform: uppercase;
    }

    .ll-s {
      font-size: 10px;
      font-weight: 400;
      font-style: italic;
      letter-spacing: 0.05em;
      color: rgba(255, 255, 255, 0.5);
      display: block;
      margin-top: 3px;
    }

    .leaflet-container {
      background: #1a1a1a !important;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="title">NAIROBI, KENYA</div>
  <div id="subtitle">Real Data: NASA POWER • OpenStreetMap • Kenya Census 2019</div>

  <div id="container">
    <div id="stage">
      <div id="persp">
        <div id="scene">
          <!-- Geography Base Layer -->
          <div class="layer" id="layer0">
            <div class="lf">
              <div class="map-container" id="map0"></div>
              <div class="loading">Loading map...</div>
            </div>
            <div class="llabel">
              <div class="ll-line"></div>
              <div>
                <span class="ll-n">Geography</span>
                <span class="ll-s">OpenStreetMap tiles</span>
              </div>
            </div>
          </div>

          <!-- Solar Layer -->
          <div class="layer" id="layer1">
            <div class="lf">
              <div class="map-container" id="map1"></div>
              <canvas class="overlay-canvas" id="solar-overlay"></canvas>
            </div>
            <div class="llabel">
              <div class="ll-line"></div>
              <div>
                <span class="ll-n">Solar Irradiance</span>
                <span class="ll-s">NASA POWER 5.8 kWh/m²/day</span>
              </div>
            </div>
          </div>

          <!-- Wind Layer -->
          <div class="layer" id="layer2">
            <div class="lf">
              <div class="map-container" id="map2"></div>
              <canvas class="overlay-canvas" id="wind-overlay"></canvas>
            </div>
            <div class="llabel">
              <div class="ll-line"></div>
              <div>
                <span class="ll-n">Wind Potential</span>
                <span class="ll-s">Global Wind Atlas data</span>
              </div>
            </div>
          </div>

          <!-- Grid Layer -->
          <div class="layer" id="layer3">
            <div class="lf">
              <div class="map-container" id="map3"></div>
              <canvas class="overlay-canvas" id="grid-overlay"></canvas>
            </div>
            <div class="llabel">
              <div class="ll-line"></div>
              <div>
                <span class="ll-n">Electric Grid</span>
                <span class="ll-s">KPLC infrastructure (OSM)</span>
              </div>
            </div>
          </div>

          <!-- Population Layer -->
          <div class="layer" id="layer4">
            <div class="lf">
              <div class="map-container" id="map4"></div>
              <canvas class="overlay-canvas" id="pop-overlay"></canvas>
            </div>
            <div class="llabel">
              <div class="ll-line"></div>
              <div>
                <span class="ll-n">Population</span>
                <span class="ll-s">Census 2019 • 68% grid access</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Nairobi bounds
    const center = [-1.286389, 36.817223];
    const bounds = [[-1.45, 36.65], [-1.15, 37.10]];

    // Initialize all 5 maps
    const maps = [];
    for (let i = 0; i < 5; i++) {
      const map = L.map(`map${i}`, {
        center: center,
        zoom: 11,
        zoomControl: false,
        attributionControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false
      });

      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        opacity: i === 0 ? 0.9 : 0.3
      }).addTo(map);

      maps.push(map);
    }

    // Load and render real data
    Promise.all([
      fetch('/data/nairobi-solar-cbd.json').then(r => r.json()),
      fetch('/data/nairobi-solar-eastlands.json').then(r => r.json()),
      fetch('/data/nairobi-solar-karen.json').then(r => r.json()),
      fetch('/data/nairobi-solar-kasarani.json').then(r => r.json()),
      fetch('/data/nairobi-solar-westlands.json').then(r => r.json()),
      fetch('/data/nairobi-grid.json').then(r => r.json()),
      fetch('/data/nairobi-population.json').then(r => r.json()),
      fetch('/data/nairobi-wind.json').then(r => r.json())
    ]).then(([solarCBD, solarEast, solarKaren, solarKasarani, solarWest, grid, population, wind]) => {

      // SOLAR LAYER
      const solarData = [solarCBD, solarEast, solarKaren, solarKasarani, solarWest];
      solarData.forEach(data => {
        const coords = data.geometry.coordinates;
        const props = data.properties.parameter.ALLSKY_SFC_SW_DWN;
        const avg = Object.values(props).slice(0, 12).reduce((a, b) => a + b, 0) / 12;

        const circle = L.circleMarker([coords[1], coords[0]], {
          radius: 80,
          fillColor: '#ff6600',
          fillOpacity: 0.4,
          stroke: false
        }).addTo(maps[1]);

        L.marker([coords[1], coords[0]], {
          icon: L.divIcon({
            className: 'solar-label',
            html: `<div style="background: rgba(0,0,0,0.7); color: #ff6600; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap;">${avg.toFixed(1)} kWh/m²</div>`,
            iconSize: [80, 20]
          })
        }).addTo(maps[1]);
      });

      // WIND LAYER
      wind.locations.forEach(loc => {
        const color = loc.viability === 'high' ? '#0066ff' : loc.viability === 'moderate' ? '#4488ff' : '#8899ff';
        const opacity = loc.viability === 'high' ? 0.6 : 0.3;

        L.circleMarker([loc.lat, loc.lon], {
          radius: loc.viability === 'high' ? 100 : 60,
          fillColor: color,
          fillOpacity: opacity,
          stroke: false
        }).addTo(maps[2]);

        L.marker([loc.lat, loc.lon], {
          icon: L.divIcon({
            className: 'wind-label',
            html: `<div style="background: rgba(0,0,0,0.7); color: ${color}; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap;">${loc.name}<br>${loc.wind_speed_ms} m/s</div>`,
            iconSize: [100, 30]
          })
        }).addTo(maps[2]);
      });

      // GRID LAYER
      grid.elements.forEach(element => {
        if (element.type === 'node' && element.tags && element.tags.power === 'substation') {
          L.circleMarker([element.lat, element.lon], {
            radius: 4,
            fillColor: '#ff0000',
            fillOpacity: 0.9,
            color: '#ffffff',
            weight: 1
          }).addTo(maps[3]);
        }

        if (element.type === 'way' && element.tags && element.tags.power === 'line' && element.geometry) {
          const coords = element.geometry.map(g => [g.lat, g.lon]);
          L.polyline(coords, {
            color: '#ff3333',
            weight: 2,
            opacity: 0.7
          }).addTo(maps[3]);
        }
      });

      // POPULATION LAYER
      population.constituencies.forEach(area => {
        const isInformal = area.type === 'informal';
        const color = isInformal ? '#ff0000' : '#ff6600';
        const radius = Math.sqrt(area.density_per_km2) / 30;

        L.circleMarker([area.lat, area.lon], {
          radius: radius,
          fillColor: color,
          fillOpacity: isInformal ? 0.6 : 0.4,
          color: color,
          weight: 2,
          opacity: 0.8
        }).addTo(maps[4]);

        L.marker([area.lat, area.lon], {
          icon: L.divIcon({
            className: 'pop-label',
            html: `<div style="background: rgba(0,0,0,0.8); color: ${color}; padding: 6px 10px; border-radius: 4px; font-size: 10px; font-weight: bold; white-space: nowrap; border: 1px solid ${color};">
              <div style="font-size: 11px;">${area.name}</div>
              <div style="opacity: 0.8; margin-top: 2px;">${(area.density_per_km2/1000).toFixed(1)}k/km²</div>
              <div style="opacity: 0.8; margin-top: 2px;">${area.grid_access_percent}% grid</div>
            </div>`,
            iconSize: [120, 60]
          })
        }).addTo(maps[4]);
      });

      // Hide loading indicators
      document.querySelectorAll('.loading').forEach(el => el.style.display = 'none');
    }).catch(err => {
      console.error('Error loading data:', err);
    });

    // Animation
    const scene = document.getElementById('scene');
    const container = document.getElementById('container');
    const layers = document.querySelectorAll('.layer');

    setTimeout(() => scene.classList.add('show'), 500);

    const ease = (t) => t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;

    function animate() {
      const rect = container.getBoundingClientRect();
      const scrollProgress = Math.max(0, Math.min(1, (window.innerHeight - rect.top) / (rect.height)));
      const ep = ease(Math.min(scrollProgress / 0.80, 1));

      layers.forEach((layer, i) => {
        const separationZ = i * 120 * ep;
        layer.style.transform = `translateZ(${separationZ}px)`;
        layer.style.opacity = '1';
        if (ep > 0.10) {
          layer.classList.add('open');
        } else {
          layer.classList.remove('open');
        }
      });

      requestAnimationFrame(animate);
    }

    animate();
  </script>
</body>
</html>
